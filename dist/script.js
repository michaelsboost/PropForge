const e={"25k_phase1":{name:"25K Challenge - Phase 1",target:1250,maxLoss:1500,maxLots:2,startBalance:25e3,next:"25k_phase2"},"25k_phase2":{name:"25K Challenge - Phase 2 (Sim Funded)",target:1250,maxLoss:1500,maxLots:2,startBalance:25e3,next:"50k_phase1"},"50k_phase1":{name:"50K Challenge - Phase 1",target:2500,maxLoss:3e3,maxLots:5,startBalance:5e4,next:"50k_phase2"},"50k_phase2":{name:"50K Challenge - Phase 2 (Sim Funded)",target:2500,maxLoss:3e3,maxLots:5,startBalance:5e4,next:"100k_phase1"},"100k_phase1":{name:"100K Challenge - Phase 1",target:6e3,maxLoss:6e3,maxLots:12,startBalance:1e5,next:"100k_phase2"},"100k_phase2":{name:"100K Challenge - Phase 2 (Sim Funded)",target:6e3,maxLoss:6e3,maxLots:12,startBalance:1e5,next:"150k_phase1"},"150k_phase1":{name:"150K Challenge - Phase 1",target:9e3,maxLoss:7500,maxLots:15,startBalance:15e4,next:"150k_phase2"},"150k_phase2":{name:"150K Challenge - Phase 2 (Sim Funded)",target:9e3,maxLoss:7500,maxLots:15,startBalance:15e4,next:"300k_phase1"},"300k_phase1":{name:"300K Challenge - Phase 1",target:18e3,maxLoss:12e3,maxLots:25,startBalance:3e5,next:"300k_phase2"},"300k_phase2":{name:"300K Challenge - Phase 2 (Sim Funded)",target:18e3,maxLoss:12e3,maxLots:25,startBalance:3e5,next:"1m_phase1"},"1m_phase1":{name:"1M Challenge - Phase 1",target:4e4,maxLoss:25e3,maxLots:40,startBalance:1e6,next:"1m_phase2"},"1m_phase2":{name:"1M Challenge - Phase 2 (Sim Funded)",target:4e4,maxLoss:25e3,maxLots:40,startBalance:1e6,next:null}},t=(()=>{const n={phase:"25k_phase1",balance:25e3,marginUsed:0,contract:"mini",lotSize:1,stopLoss:10,takeProfit:10,trades:[],openTrades:[],currentPrice:4215.25,todayPNL:0,justAdvanced:!1,isFullyTrained:!1,challenge:{phase:1,level:"25K",profitTarget:1250,maxTotalLoss:1500,startingBalance:25e3,phaseProgress:0},candles:(()=>{const e=[];let t=4200,n=1;for(let a=0;a<100;a++){const o=3,s=t,r=Math.random()*o,l=Math.random()>.3?n:-n,i=s+r*l,c=Math.max(s,i)+Math.random(),d=Math.min(s,i)-Math.random();t=i,n=l,e.push({open:s,close:i,high:c,low:d,timestamp:Date.now()-1e3*(100-a)})}return e})()};function r(){localStorage.removeItem("PropForge"),sessionStorage.removeItem("PropForge"),document.cookie.split(";").forEach((function(e){e.trim().startsWith("PropForge")&&(document.cookie=e.trim().split("=")[0]+"=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/")})),"caches"in window&&caches.keys().then((function(e){e.forEach((function(e){"PropForge-cache"===e&&caches.delete(e)}))})),"serviceWorker"in navigator&&navigator.serviceWorker.getRegistrations().then((function(e){e.forEach((function(e){e.scope.includes("PropForge")&&e.unregister()}))}))}function l(){const t=e[n.phase];n.balance=t.startBalance,n.marginUsed=0,n.trades=[],n.openTrades=[],n.todayPNL=0,r()}function i(){const n=t.state.phase,a=e[n],o=a?.next;if(t.state.justAdvanced=!0,!o){if(!t.state.isFullyTrained){t.state.isFullyTrained=!0;const e="🎉 Training Complete!",n="You're now free to trade without limits.";"granted"===Notification.permission?new Notification(e,{body:n}):"denied"!==Notification.permission&&Notification.requestPermission().then((t=>{"granted"===t&&new Notification(e,{body:n})})),s.update(t.state)}return void(t.state.justAdvanced=!1)}const r=e[o];t.state.phase=o,t.state.balance=r.startBalance,t.state.marginUsed=0,t.state.trades=[],t.state.openTrades=[],t.state.todayPNL=0,t.state.challenge={phase:r.name.includes("Phase 1")?1:2,level:r.name.split(" ")[0].replace("K","K"),profitTarget:r.target,maxTotalLoss:r.maxLoss,startingBalance:r.startBalance,phaseProgress:0},setTimeout((()=>{t.state.justAdvanced=!1}),1500),s.update(t.state)}function c(){if(n.justAdvanced)return;const a=e[n.phase];if(!a)return;const o=n.balance-a.startBalance;if(n.balance<=a.startBalance-a.maxLoss)return alert("🚨 Challenge failed. Restarting 25K Phase 1."),t.state.phase="25k_phase1",void l();o>=a.target&&(t.state.justAdvanced=!0,function(e){if(t.state.isFullyTrained)return;const n=`${e.level} Phase ${e.phase} Complete!`,a="You've successfully advanced to the next challenge phase.";"granted"===Notification.permission?new Notification(n,{body:a}):"denied"!==Notification.permission&&Notification.requestPermission().then((e=>{"granted"===e&&new Notification(n,{body:a})}))}(t.state.challenge),i())}return setInterval((function(){const l=(2*Math.random()-1).toFixed(2);n.currentPrice=parseFloat((n.currentPrice+parseFloat(l)).toFixed(2));const i=n.candles[n.candles.length-1],d=Date.now();!i||d-i.timestamp>1e3?n.candles.push({open:n.currentPrice,high:n.currentPrice,low:n.currentPrice,close:n.currentPrice,timestamp:d}):(i.high=Math.max(i.high,n.currentPrice),i.low=Math.min(i.low,n.currentPrice),i.close=n.currentPrice),n.candles.length>200&&n.candles.shift(),o.evaluate(n),c();const u=n.openTrades.reduce(((e,t)=>{const a=t.entry,o=n.currentPrice;return e+("buy"===t.type?o-a:a-o)*t.qty*t.contractValue}),0);n.challenge.startingBalance-(n.balance+u)>=n.challenge.maxTotalLoss?function(n){const o=t.state.phase,l=e[o];n&&alert("🚨 Max total loss exceeded. Resetting the challenge..."),t.state.balance=l.startBalance,t.state.marginUsed=0,t.state.trades=[],t.state.openTrades=[],t.state.todayPNL=0,t.state.challenge={phase:1,level:"25K",profitTarget:1250,maxTotalLoss:1500,startingBalance:25e3,speed:"tick",phaseProgress:0},s.update(t.state),a.draw(t.state),r()}():(s.update(n),a.draw(n))}),100),{state:n,resetPhase:l,advancePhase:i,getMaxLotsAllowed:function(){const t=e[n.phase];return t?"micro"===n.contract?10*t.maxLots:t.maxLots:1/0}}})(),n={render:function({large:e,title:t="Are you sure you want to proceed?",content:n,CloseLabel:a,ConfirmLabel:o,onLoad:s,onClose:r,onConfirm:l}){const i="text-xs w-auto px-3 py-2 m-0 capitalize rounded-md",c=`<article class="${e?"flex flex-col h-3/4":""} rounded-md">\n      <header class="${e?"flex-none":""} flex justify-between items-center">\n        <h1 class="text-lg font-thin m-0">${t}</h1>\n        <button class="${i} bg-transparent border-0" style="color: unset;" aria-label="Close"><svg class="w-3" viewBox="0 0 384 512">\n        <path fill="currentColor" d="M342.6 150.6c12.5-12.5 12.5-32.8 \n        0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5\n        -45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 \n        32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 \n        12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/>\n      </svg></button>\n      </header>\n      <main class="font-thin ${e?"flex-grow":""}">\n        ${n||""}\n      </main>\n      <footer ${e?'class="flex-none"':""}>\n        <button class="${i} bg-transparent border border-gray-600" aria-label="Close">${a||"close"}</button>\n        ${l?`<button class="${i}" aria-label="Confirm">${o||"confirm"}</button>`:""}\n      </footer>\n    </article>`,d=document.createElement("dialog");d.open=!0,d.innerHTML=c,document.body.appendChild(d),s&&"function"==typeof s&&s();const u=d.querySelector("header button"),m=d.querySelector("footer button:first-child"),h=d.querySelector("footer button:last-child"),p=()=>{document.body.removeChild(d)};u.onclick=()=>{r&&r(),p()},m.onclick=()=>{r&&r(),p()},l&&h&&(h.onclick=()=>{l(),p()})}},a=(()=>{const e=document.getElementById("chart"),n=e.getContext("2d");let a=1,o=null,s=0;function r(n){const{x:r,y:l}=function(t){const n=e.getBoundingClientRect(),a=t.touches?t.touches[0].clientX:t.clientX,o=t.touches?t.touches[0].clientY:t.clientY;return{x:a-n.left,y:o-n.top}}(n);o=null;const i=t.state,c=e.height,d=Math.floor(60/a),u=Math.max(0,i.candles.length-d-Math.floor(0)),m=i.candles.slice(u,u+d);let h=Math.max(...m.map((e=>e.high))),p=Math.min(...m.map((e=>e.low)));const g=.05*(h-p);h+=g,p-=g,i.openTrades.forEach((e=>{h=Math.max(h,e.entry,e.stop,e.target),p=Math.min(p,e.entry,e.stop,e.target)}));const f=(c-20)/(h-p);i.openTrades.forEach((e=>{const t=(t,a)=>{const r=c-(t-p)*f-10,i=n.touches?10:6;Math.abs(r-l)<i&&(o={trade:e,key:a},s=r-l)};t(e.stop,"stop"),t(e.target,"target")})),o||(n.touches?n.touches[0].clientX:n.clientX)}function l(){o=null}function i(n){if(!e)return;const r=t.state,l=e.getBoundingClientRect();n.touches?n.touches[0].clientX:n.clientX;const i=(n.touches?n.touches[0].clientY:n.clientY)-l.top,c=e.height,d=Math.floor(60/a),u=Math.max(0,r.candles.length-d-Math.floor(0)),m=r.candles.slice(u,u+d);let h=Math.max(...m.map((e=>e.high))),p=Math.min(...m.map((e=>e.low)));const g=.05*(h-p);h+=g,p-=g,r.openTrades.forEach((e=>{h=Math.max(h,e.entry,e.stop,e.target),p=Math.min(p,e.entry,e.stop,e.target)}));const f=(c-20)/(h-p);if(o){n.preventDefault();const e=parseFloat(((c-(i+s)-10)/f+p).toFixed(2));o.trade[o.key]=e,"stop"===o.key&&(o.trade.stopMoved=!0),"target"===o.key&&(o.trade.targetMoved=!0)}}return e.addEventListener("wheel",(e=>{e.preventDefault();const t=e.deltaY>0?.9:1.1;a*=t,a=Math.max(.5,Math.min(a,10))})),e.addEventListener("mousedown",r),e.addEventListener("touchstart",r),e.addEventListener("mousemove",i),e.addEventListener("touchmove",i,{passive:!1}),e.addEventListener("mouseup",l),e.addEventListener("touchend",l),e.addEventListener("mouseleave",l),e.addEventListener("touchcancel",l),{draw:function(t){if(!e||!n)return;e.width=e.offsetWidth,e.height=e.offsetHeight;const s=e.width,r=e.height,l=10;n.clearRect(0,0,s,r);const i=Math.floor(60/a),c=Math.max(0,t.candles.length-i-Math.floor(0)),d=t.candles.slice(c,c+i);if(d.length<2)return;let u=Math.max(...d.map((e=>e.high))),m=Math.min(...d.map((e=>e.low)));const h=.05*(u-m);u+=h,m-=h,t.openTrades.forEach((e=>{u=Math.max(u,e.entry,e.stop,e.target),m=Math.min(m,e.entry,e.stop,e.target)}));const p=(r-20)/(u-m),g=(s-60)/d.length;n.strokeStyle="#333",n.fillStyle="#888",n.font="10px sans-serif",n.textAlign="right",n.textBaseline="middle";for(let e=0;e<=10;e++){const t=l+(r-20)*e/10,a=u-(u-m)*e/10;n.beginPath(),n.moveTo(0,t),n.lineTo(s,t),n.stroke(),n.fillText(a.toFixed(2),s-4,t)}d.forEach(((e,t)=>{const a=t*g,o=r-(e.open-m)*p-l,s=r-(e.close-m)*p-l,i=r-(e.high-m)*p-l,c=r-(e.low-m)*p-l,d=e.close>=e.open;n.strokeStyle=d?"#089a81":"#f33645",n.fillStyle=d?"#089a81":"#f33645",n.beginPath(),n.moveTo(a+g/2,i),n.lineTo(a+g/2,c),n.stroke();const u=d?s:o,h=Math.max(1,Math.abs(o-s));n.fillRect(a+1,u,g-2,h)})),t.openTrades.forEach((e=>{const a=(a,i,c,d)=>{const u=r-(a-m)*p-l;n.strokeStyle=o&&o.trade===e&&o.key===d?"#ff0":i,n.lineWidth=2,n.beginPath(),n.moveTo(0,u),n.lineTo(s,u),n.stroke();let h="";if("SL"===c||"TP"===c){const n="buy"===e.type?1:-1,o=(a-e.entry)*n,s=.25,r=Math.round(o/s),l=r*("micro"===t.contract?.5:5)*e.qty;h=` → ${l>=0?"+":""}$${l.toFixed(2)} (${r} ticks)`}n.fillStyle=n.strokeStyle,n.font="11px sans-serif",n.textAlign="left",n.fillText(`${c} ${a.toFixed(2)}${h}`,8,u-4)};a(e.entry,"buy"===e.type?"#0f0":"#f00","Entry"),a(e.stop,"#888","SL","stop"),a(e.target,"#888","TP","target")}));const f=r-(t.currentPrice-m)*p-l;n.fillStyle="#111",n.strokeStyle="#0ff",n.lineWidth=1,n.beginPath(),n.rect(s-60,f-10,55,20),n.fill(),n.stroke(),n.fillStyle="#0ff",n.font="12px sans-serif",n.textAlign="center",n.textBaseline="middle",n.fillText(t.currentPrice.toFixed(2),s-60+27.5,f)}}})(),o=(()=>{function n(e){const t=document.getElementById("tradeMessage");t&&(t.textContent=e,setTimeout((()=>{t.textContent=""}),3e3))}return{place:function(a,o){const s=o.currentPrice,r=o.lotSize,l=e[o.phase]||null,i=("micro"===o.contract?r/10:r)+o.openTrades.reduce(((e,t)=>e+(2===t.contractValue?t.qty/10:t.qty)),0);if(t.state.isFullyTrained&&!l)return function(e,t,a,o){const s="micro"===t.contract?2:20,r=a*("micro"===t.contract?500:1e4),l=t.balance-t.marginUsed;if(document.querySelectorAll("[data-find=margin]").forEach((e=>{e.classList.contains("hidden")&&e.classList.remove("hidden")})),r>l)return void n(`❌ Not enough margin: Need $${r}, Have $${l}`);const i={type:e,qty:a,entry:o,stop:"buy"===e?o-t.stopLoss:o+t.stopLoss,target:"buy"===e?o+t.takeProfit:o-t.takeProfit,entryTime:Date.now(),contractValue:s,marginRequired:r};t.openTrades.push(i),t.marginUsed+=r,n(`✅ Placed ${e} (Free Mode)`)}(a,o,r,s);const c=t.getMaxLotsAllowed();if(i>c)return void n(`❌ Max lot size exceeded: Limit is ${c}, Attempted ${i.toFixed(2)}`);const d="micro"===o.contract?2:20,u="micro"===o.contract?500:1e4,m=o.openTrades.find((e=>e.type!==a)),h=o.openTrades.find((e=>e.type===a)),p=o.balance-o.marginUsed;if(m){let e=r;for(let t=0;t<o.openTrades.length&&e>0;t++){const n=o.openTrades[t];if(n.type!==a){const t=Math.min(e,n.qty),r=("buy"===a?s-n.entry:n.entry-s)*t*n.contractValue;o.trades.push({...n,exit:s,pnl:r,qty:t,duration:Date.now()-n.entryTime,exitReason:"Reduced",time:(new Date).toLocaleTimeString()}),n.qty-=t,o.marginUsed-=t*u,o.balance+=r,e-=t}}if(o.openTrades=o.openTrades.filter((e=>e.qty>0)),e>0){const t=e*u;if(t>o.balance-o.marginUsed)return void n(`❌ Not enough margin: Need $${t}, Have $${p}`);const r={type:a,qty:e,entry:s,stop:"buy"===a?s-o.stopLoss:s+o.stopLoss,target:"buy"===a?s+o.takeProfit:s-o.takeProfit,entryTime:Date.now(),contractValue:d,marginRequired:t};o.openTrades.push(r),o.marginUsed+=t}return}if(h){const e=r*u;if(e>p)return void n(`❌ Not enough margin to scale in: Need $${e}, Have $${p}`);const t=h.qty+r;return h.entry=(h.entry*h.qty+s*r)/t,h.qty=t,h.marginRequired+=e,o.marginUsed+=e,h.stopMoved||(h.stop="buy"===a?h.entry-o.stopLoss:h.entry+o.stopLoss),void(h.targetMoved||(h.target="buy"===a?h.entry+o.takeProfit:h.entry-o.takeProfit))}const g=r*u;if(g>p)return void n(`❌ Not enough margin: Need $${g}, Have $${p}`);const f={type:a,qty:r,entry:s,stop:"buy"===a?s-o.stopLoss:s+o.stopLoss,target:"buy"===a?s+o.takeProfit:s-o.takeProfit,entryTime:Date.now(),contractValue:d,marginRequired:g};o.openTrades.push(f),o.marginUsed+=g},evaluate:function(e){const t=Date.now();e.openTrades=e.openTrades.filter((n=>{const a=e.currentPrice,o="buy"===n.type?a>=n.target:a<=n.target,s="buy"===n.type?a<=n.stop:a>=n.stop;if(o||s){const s=a,l=("buy"===n.type?s-n.entry:n.entry-s)*n.qty*n.contractValue;return e.trades.push({...n,exit:s,pnl:l,duration:t-n.entryTime,exitReason:o?"TP":"SL",time:(new Date).toLocaleTimeString()}),e.marginUsed-=n.marginRequired,e.balance+=l,r(),!1}return!0}))}}})(),s=(()=>{let e=0;function n(e,t){const n=document.getElementById(e);n&&n.textContent!==t&&(n.textContent=t)}return{update:function(a){const o=a.challenge,s=a.trades,r=s.filter((e=>e.pnl>0)),l=s.filter((e=>e.pnl<0));s.reduce(((e,t)=>e+t.pnl),0);const i=s.length?(r.length/s.length*100).toFixed(1)+"%":"0%";r.length&&(r.reduce(((e,t)=>e+t.pnl),0),r.length),l.length&&(l.reduce(((e,t)=>e+t.pnl),0),l.length),r.length&&(r.reduce(((e,t)=>e+t.duration),0),r.length),l.length&&(l.reduce(((e,t)=>e+t.duration),0),l.length);const c=a.balance-o.startingBalance,d=Math.min(100,c/o.profitTarget*100),u=["25K","50K","100K","150K","300K","500K","1M"],m=u.indexOf(o.level);if(document.querySelector(".progress-fill").style.width=`${d}%`,n("tier-progress-text",`${m+1}/${u.length}`),n("account-tier",`$${o.level} Challenge`),n("account-phase",`Phase ${o.phase}/2`),document.querySelector(".progress-label").textContent=`${d.toFixed(0)}%`,n("challenge-title",t.state.isFullyTrained?"🎉 Free Mode (No Restrictions)":"Current Challenge"),t.state.isFullyTrained)n("profit-target","🎯 Training complete"),n("total-loss","∞"),n("max-lots","∞"),document.querySelector(".progress-fill").style.background="gold",document.getElementById("tier-progress").style.background="gold";else{t.state.phase,n("profit-target",`$${o.profitTarget.toLocaleString()}`),n("total-loss",`$${o.maxTotalLoss.toLocaleString()}`);n("max-lots",`${t.getMaxLotsAllowed()}`)}if(n("totalOpenLots",a.openTrades.reduce(((e,t)=>e+t.qty),0).toString()),n("current-profit",`$${c.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}`),n("open-pnl",`$${a.openTrades.reduce(((e,t)=>e+("buy"===t.type?a.currentPrice-t.entry:t.entry-a.currentPrice)*t.qty*t.contractValue),0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}`),n("balance",`$${a.balance.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}`),n("lotSizeDisplay",t.state.lotSize.toString()),n("marginUsed",`$${a.marginUsed.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}`),n("availableMargin",`$${(a.balance-a.marginUsed).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}`),n("totalTrades",s.length.toString()),n("winlossratio",i),s.length!==e){e=s.length;document.getElementById("history").querySelector("tbody").innerHTML=s.map((e=>`\n        <tr>\n          <td>${e.time}</td>\n          <td>${e.type}</td>\n          <td>${e.qty}</td>\n          <td>${e.entry.toFixed(2)}</td>\n          <td>${e.exit.toFixed(2)}</td>\n          <td style="color:${e.pnl>=0?"limegreen":"red"}">${e.pnl.toFixed(2)}</td>\n          <td>${(e.duration/1e3).toFixed(1)}s</td>\n          <td>${e.exitReason||"Manual"}</td>\n        </tr>\n      `)).reverse().join("")}}}})();function r(){const e={...t.state};e.openTrades=[];try{localStorage.setItem("PropForge",JSON.stringify(e))}catch(e){console.error("Failed to save state:",e)}}function l(n){const a=e[t.state.phase],o=t.state.lotSize+n;t.state.isFullyTrained&&!a||(o<1?alert("❌ Lot size can't be less than 1"):o>a.maxLots?alert(`❌ Lot size can't exceed max allowed: ${a.maxLots}`):(t.state.lotSize=o,document.getElementById("lotSizeDisplay").textContent=o,document.querySelectorAll('input[name="lot"]').forEach((e=>{e.checked=parseInt(e.value)===o}))))}document.querySelectorAll('input[name="contract"]').forEach((e=>{e.addEventListener("change",(()=>{const n=e.value;if(t.state.openTrades.length>0)return e.checked=!1,document.querySelector(`input[name="contract"][value="${t.state.contract}"]`).checked=!0,void alert("❌ Cannot change contract type while trades are open");t.state.contract=n}))})),document.querySelectorAll('input[name="lot"]').forEach((n=>{n.addEventListener("change",(()=>{const a=parseInt(n.value),o=e[t.state.phase].maxLots;a>o?(n.checked=!1,alert(`❌ Max allowed lot size: ${o}`),t.state.lotSize=Math.min(t.state.lotSize,o),document.getElementById("lotSizeDisplay").textContent=t.state.lotSize,document.querySelectorAll('input[name="lot"]').forEach((e=>e.checked=!1)),document.querySelectorAll('input[name="lot"]').forEach((e=>{parseInt(e.value)===t.state.lotSize&&(e.checked=!0)}))):(t.state.lotSize=a,document.getElementById("lotSizeDisplay").textContent=a)}))})),document.getElementById("stopLossAmount").addEventListener("input",(e=>{t.state.stopLoss=parseFloat(e.target.value)})),document.getElementById("takeProfitAmount").addEventListener("input",(e=>{t.state.takeProfit=parseFloat(e.target.value)})),document.addEventListener("keydown",(e=>{"+"!==e.key&&"="!==e.key||l(1),"-"!==e.key&&"_"!==e.key||l(-1),"b"===e.key.toLowerCase()&&o.place("buy",t.state),"s"===e.key.toLowerCase()&&o.place("sell",t.state),"x"===e.key.toLowerCase()&&document.getElementById("close").click()})),document.getElementById("buy").addEventListener("click",(()=>{o.place("buy",t.state)})),document.getElementById("sell").addEventListener("click",(()=>{o.place("sell",t.state)})),document.getElementById("close").addEventListener("click",(()=>{const e=t.state,n=Date.now();e.openTrades.forEach((t=>{const a=e.currentPrice,o=("buy"===t.type?a-t.entry:t.entry-a)*t.qty*t.contractValue;e.trades.push({...t,exit:a,pnl:o,duration:n-t.entryTime,exitReason:"Manual",time:(new Date).toLocaleTimeString()}),e.marginUsed-=t.marginRequired,e.balance+=o,r()})),e.openTrades=[],s.update(e)})),document.querySelectorAll('button[data-open="performance"]').forEach((e=>{e.onclick=function(){const e=t.state,o=e.challenge,l=e.trades,i=l.filter((e=>e.pnl>0)),c=l.filter((e=>e.pnl<0)),d=l.reduce(((e,t)=>e+t.pnl),0),u=l.length?(i.length/l.length*100).toFixed(1)+"%":"0%",m=i.length?i.reduce(((e,t)=>e+t.pnl),0)/i.length:0,h=c.length?c.reduce(((e,t)=>e+t.pnl),0)/c.length:0,p=i.length?i.reduce(((e,t)=>e+t.duration),0)/i.length:0,g=c.length?c.reduce(((e,t)=>e+t.duration),0)/c.length:0,f=e=>`${e>=0?"+":"-"}$${Math.abs(e).toFixed(2)}`,y=e=>`${(e/1e3).toFixed(1)}s`,x=l.length?l.reduce(((e,t)=>t.pnl>e.pnl?t:e)):null,v=l.length>1?l.reduce(((e,t)=>t.pnl<e.pnl?t:e)):null,L={};l.forEach((e=>{const t=function(e){const t=e/1e3;return t<30?"< 30s":t<60?"30s - 1m":t<180?"1-3m":t<600?"3-10m":"> 10m"}(e.duration);L[t]=(L[t]||0)+1}));const b=Object.entries(L).sort(((e,t)=>t[1]-e[1])),k=b[0]?.[0]??"--",$=b[b.length-1]?.[0]??"--",T=`\n      <div class="trading-card rounded-xl p-5">\n        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 text-sm text-slate-300">\n          ${[{label:"Total PnL",value:`$${d.toFixed(2)}`,class:d>=0?"text-green-400":"text-red-400"},{label:"Total Trades",value:l.length},{label:"Win Rate",value:u},{label:"Avg Win",value:`$${m.toFixed(2)}`},{label:"Avg Loss",value:`$${h.toFixed(2)}`},{label:"Best Trade",value:x?f(x.pnl):"--",class:x?x.pnl>=0?"text-green-400":"text-red-400":""},{label:"Worst Trade",value:v?f(v.pnl):"--",class:v?v.pnl>=0?"text-green-400":"text-red-400":""},{label:"Avg Win Duration",value:y(p)},{label:"Avg Loss Duration",value:y(g)},{label:"Best Duration Bracket",value:k},{label:"Worst Duration Bracket",value:$},{label:"Challenge",value:`${o.level} Phase ${o.phase}/2`}].map((e=>`\n            <div>\n              <span class="text-slate-500 block">${e.label}</span>\n              <span class="font-bold ${e.class??""}">${e.value}</span>\n            </div>\n          `)).join("")}\n        </div>\n\n        <div class="grid grid-cols-2 gap-3 mt-4 text-sm">\n          <button id="importBackupBtn" class="bg-green-600 text-white text-sm px-4 py-2 rounded-md text-center cursor-pointer w-full sm:w-auto border-0">\n            <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">\n              <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5"></path>\n            </svg>\n            Import Backup (.json)\n          </button>\n          <button id="exportBackupBtn" class="bg-blue-600 text-white text-sm px-4 py-2 rounded-md text-center cursor-pointer w-full sm:w-auto border-0">\n            <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">\n              <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5"></path>\n            </svg>\n            Export Backup (.json)\n          </button>\n        </div>\n        <input type="file" id="importBackupInput" accept=".json" class="hidden" />\n      </div>\n    `;n.render({title:"📈 Performance Card",content:T,ConfirmLabel:"Reset",CloseLabel:"Cancel",onLoad:()=>{setTimeout((()=>{const e=document.getElementById("exportBackupBtn"),n=document.getElementById("importBackupBtn"),o=document.getElementById("importBackupInput");n.addEventListener("click",(()=>{o.click()})),e.addEventListener("click",(()=>{const e={...t.state,openTrades:[]},n=JSON.stringify(e,null,2),a=new Blob([n],{type:"application/json"}),o=URL.createObjectURL(a),s=document.createElement("a");s.href=o,s.download=`trading-backup-${(new Date).toISOString().split("T")[0]}.json`,s.click(),URL.revokeObjectURL(o)})),o.addEventListener("change",(e=>{const n=e.target.files[0];if(!n)return;const o=new FileReader;o.onload=e=>{try{const n=JSON.parse(e.target.result);if(!n||"object"!=typeof n||!n.trades||!n.challenge)return void alert("Invalid backup file.");Object.assign(t.state,n),t.state.openTrades=[],r(),s.update(t.state),a.draw(t.state),location.reload(!0)}catch(e){alert("❌ Failed to import backup.")}},o.readAsText(n)}))}),50)},onConfirm:()=>t.resetPhase()})}})),window.addEventListener("DOMContentLoaded",(()=>{!function(){const e=localStorage.getItem("PropForge");if(e)try{const n=JSON.parse(e);Object.assign(t.state,n)}catch(e){console.error("Failed to load state:",e)}}(),document.getElementById("lotDecrease").addEventListener("click",(()=>l(-1))),document.getElementById("lotIncrease").addEventListener("click",(()=>l(1))),document.querySelector(`input[name="contract"][value="${t.state.contract}"]`).checked=!0,document.getElementById("lotSizeDisplay").textContent=t.state.lotSize,document.querySelector(`input[name="lot"][value="${t.state.lotSize}"]`).checked=!0,document.getElementById("stopLossAmount").value=t.state.stopLoss,document.getElementById("takeProfitAmount").value=t.state.takeProfit}));
